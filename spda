import csv
import time
from datetime import datetime
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from dotenv import load_dotenv
import os

# Load environment variables
load_dotenv()
USERNAME = os.getenv("SPADA_USERNAME")
PASSWORD = os.getenv("SPADA_PASSWORD")

# Load schedule
def load_schedule(csv_file):
    with open(csv_file, newline='', encoding='utf-8') as f:
        return list(csv.DictReader(f))

# Find current class
def get_current_class(schedule):
    now = datetime.now()
    day_map = {
        "Monday": "Senin", "Tuesday": "Selasa", "Wednesday": "Rabu",
        "Thursday": "Kamis", "Friday": "Jumat", "Saturday": "Sabtu", "Sunday": "Minggu"
    }
    today = day_map[now.strftime("%A")]
    current_time = now.strftime("%H:%M")

    for entry in schedule:
        if entry["Day"] == today:
            start_time, end_time = entry["Time"].split(" - ")
            if start_time <= current_time <= end_time:
                return entry["CourseName"]
    return None

# Launch browser
def init_driver(headless=False):
    options = Options()
    if headless:
        options.add_argument("--headless")
    return webdriver.Chrome(options=options)

# Main automation
def login_and_check(course_name):
    driver = init_driver()
    driver.get("https://spada.upnyk.ac.id/login/index.php")
    
    # Login
    driver.find_element(By.ID, "username").send_keys(USERNAME)
    driver.find_element(By.ID, "password").send_keys(PASSWORD)
    driver.find_element(By.ID, "loginbtn").click()
    time.sleep(4)

    # Search for course
    found = False
    courses = driver.find_elements(By.PARTIAL_LINK_TEXT, course_name)
    for course in courses:
        if course_name.lower() in course.text.lower():
            course.click()
            found = True
            break
    
    if not found:
        print("Course not found.")
        print(course_name)
        driver.quit()
        return

    time.sleep(3)

    # Look for 'Presensi' or 'Attendance'
    links = driver.find_elements(By.TAG_NAME, "a")
    for link in links:
        if "presensi" in link.text.lower() or "attendance" in link.text.lower():
            print(f"Found attendance link: {link.text}")
            link.click()
            break

    time.sleep(5)
    driver.quit()

# Run everything
schedule = load_schedule("schedule.csv")
current_class = get_current_class(schedule)

if current_class:
    print(f"Current class: {current_class}")
    login_and_check(current_class)
else:
    print("No class at the moment.")
